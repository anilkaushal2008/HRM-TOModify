@model IEnumerable<HRM.Models.tblConsultantSlips>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Salary Slips";
}

<style>
    .modern-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
    }

    .status-pill {
        padding: 5px 12px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .status-pending {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .status-completed {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    table thead th {
        font-weight: 700 !important;
        color: var(--text-main) !important;
        border-bottom: 2px solid var(--border) !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="font-weight-bold mb-0">Salary Requests</h3>
    @if (Session["UserId"] != null)
    {
        @* Ensure ViewBag.ID contains the Employee ID *@
        <button type="button" class="btn btn-success rounded-pill px-4 open-modal" data-id="@ViewBag.ID">
            <i class="fas fa-plus mr-2"></i> New Request
        </button>
    }
</div>

<div class="modern-card">
    <div class="table-responsive">
        <table id="slipsTable" class="table no-wrap">
            <thead>
                <tr>
                    <th>Consultant</th>
                    <th>Date</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null)
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td><strong class="text-main">@item.tblEmpAssesmentMas.vchName</strong></td>
                            <td>@item.dtRequest.ToString("dd MMM yyyy")</td>
                            <td class="text-center">
                                @if (item.bitIsComplete == true)
                                {<span class="status-pill status-completed">Completed</span> }
                                else
                                { <span class="status-pill status-pending">Pending</span>}
                            </td>
                            <td class="text-center">
                                @if (item.bitIsComplete == true)
                                {
                                    <a href="@Url.Action("PrintSlip","NewEmployeeLogin",new { id = item.UNid })" target="_blank" class="btn btn-sm btn-outline-success rounded-pill px-3">Print</a>
                                }
                                else
                                {
                                    <span class="text-muted small italic">Processing...</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div id="modalContainer"></div>
@section scripts {
    <script>
        $(document).ready(function () {
            // 1. Open Modal via AJAX
            $(document).on("click", ".open-modal", function (e) {
                e.preventDefault();
                var id = $(this).data("id");

                $.get('/NewEmployeeLogin/RequestSlip', { id: id }, function (data) {
                    $('#modalContainer').html(data);
                    var modalElement = document.getElementById('_PartialRequestNew');

                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        var modalInstance = new bootstrap.Modal(modalElement);
                        modalInstance.show();
                    } else {
                        $(modalElement).modal('show');
                    }
                });
            });

            // 2. Fix: Handle Submit Button inside AJAX Modal
            $(document).on("submit", "#modalContainer form", function (e) {
                // This ensures the form actually submits when the button is clicked
                console.log("Form is being submitted...");
            });

            // 3. Fix: Handle Close Buttons (Force close if data-attributes fail)
            $(document).on("click", "[data-dismiss='modal'], [data-bs-dismiss='modal']", function () {
                $('.modal').modal('hide'); // For BS4

                // For BS5
                var modalEl = document.getElementById('_PartialRequestNew');
                var modalInst = bootstrap.Modal.getInstance(modalEl);
                if (modalInst) modalInst.hide();
            });
        });
    </script>
}